# Slang 셰이더 언어 문법 노트

Slang은 HLSL 호환 셰이더 언어로, SPIR-V, DXIL, DXBC, Vulkan, Metal, CUDA, CPU 등 다중 타깃 컴파일을 지원한다.

---

## 1. 파일과 기본 구조

- **확장자**: `.slang` (Slang 전용), `.hlsl` (HLSL 호환)
- 여러 `.slang` 파일을 넘기면 **하나의 번역 단위**로 묶임 (서로 선언 공유)
- `.hlsl` 파일은 **파일마다 별도 번역 단위**
- `#include`로 다른 파일을 텍스트로 포함 (별도 소스 유닛 아님)

---

## 2. 엔트리 포인트 (Entry Points)

### 2.1 `[shader(...)]` 어트리뷰트 (권장)

함수에 `[shader("compute")]`, `[shader("vertex")]`, `[shader("pixel")]` 등을 붙이면 해당 함수가 엔트리 포인트로 인식된다.

```slang
[shader("compute")]
[numthreads(1, 1, 1)]
void computeMain(uint3 threadId : SV_DispatchThreadID)
{
    // ...
}

[shader("vertex")]
VertexOutput vsMain() { ... }

[shader("pixel")]
float4 psMain() : SV_Target { ... }
```

- SPIR-V, Metal, CUDA, OptiX에서는 `-entry`/`-stage` 없이 엔트리·스테이지를 추론 가능
- **HLSL 등** 타깃은 `slangc`에서 `-entry`, `-stage`를 명시해야 함

### 2.2 스테이지별 예

| 스테이지   | 어트리뷰트         | 예시 시맨틱           |
|-----------|--------------------|------------------------|
| compute   | `[shader("compute")]` | `SV_DispatchThreadID`   |
| vertex    | `[shader("vertex")]` | `SV_VertexID` 등       |
| pixel     | `[shader("pixel")]`  | `SV_Target`, `SV_Position` |

---

## 3. 전역 변수와 셰이더 파라미터

HLSL 스타일 전역 리소스 선언을 그대로 사용한다.

```slang
StructuredBuffer<float> buffer0;
StructuredBuffer<float> buffer1;
RWStructuredBuffer<float> result;

Texture2D<float4> diffuseMap;
SamplerState linearSampler;
ConstantBuffer<MyStruct> constants;
```

- 바인딩은 Slang이 자동 배치 (명시적 레이아웃은 비권장)
- `ParameterBlock` 등 타깃별 기능은 공식 문서 참고

---

## 4. 타입

### 4.1 HLSL 기본 타입

- 스칼라: `float`, `double`, `half`, `int`, `uint`, `bool`
- 벡터: `float2`, `float3`, `float4`, `int2`, `uint3` 등
- 행렬: `float3x3`, `float4x4` 등
- 텍스처/버퍼: `Texture2D`, `Texture3D`, `RWTexture2D`, `StructuredBuffer<T>`, `RWStructuredBuffer<T>`, `ConstantBuffer<T>`, `ByteAddressBuffer` 등

### 4.2 구조체 (struct)

```slang
struct VertexOutput
{
    nointerpolation int a : SOME_VALUE;
    float3 b : SV_Position;
};
```

- 시맨틱(`: SV_Position` 등) 지원
- Slang 확장: **멤버 함수**, **프로퍼티** 정의 가능

### 4.3 Slang 확장 타입

- **`var`**: 가변 변수
- **`let`**: 불변 값
- **타입 추론**: `let x = 1.0;` 등
- **튜플 타입**, **Optional**, **제네릭**, **인터페이스** 등 (고급 기능은 공식 가이드 참고)

---

## 5. 어트리뷰트 (Attributes)

| 어트리뷰트           | 용도                    |
|---------------------|-------------------------|
| `[shader("...")]`   | 엔트리 포인트 + 스테이지 |
| `[numthreads(X,Y,Z)]` | 컴퓨트 셰이더 스레드 그룹 크기 |
| `nointerpolation`   | 보간 없음 (구조체 멤버 등) |

시스템 값 시맨틱은 HLSL과 동일: `SV_Position`, `SV_Target`, `SV_DispatchThreadID`, `SV_VertexID`, `SV_InstanceID` 등.

---

## 6. 모듈과 import

### 6.1 소스 모듈

```slang
// lib.slang
public int foo(int a)
{
    return a + 1;
}
```

```slang
// entry.slang
import "lib";

[shader("compute")]
void computeMain(...)
{
    outputBuffer[index] = foo(index);
}
```

- `import "파일명"` 또는 `import "경로/모듈명"` (확장자 없이)
- 검색 경로는 `-I` 또는 API의 search path로 지정

### 6.2 사전 컴파일된 모듈 (.slang-module)

```bash
slangc lib.slang -o lib.slang-module
```

사용처에서는 동일하게 `import "lib";` 로 불러온다. 링크 시 `lib.slang-module`과 `entry.slang`(또는 entry 모듈)을 함께 넘긴다.

---

## 7. 컴파일 (slangc)

### 7.1 기본 예

```bash
# SPIR-V (엔트리 자동 추론 가능)
slangc hello-world.slang -target spirv -o hello-world.spv

# HLSL (엔트리·스테이지 명시)
slangc hello-world.slang -target hlsl -entry computeMain -stage compute -o hello-world.hlsl
```

### 7.2 자주 쓰는 옵션

| 옵션 | 설명 |
|------|------|
| `-target <format>` | `spirv`, `dxil`, `dxbc`, `hlsl`, `glsl` 등 |
| `-entry <함수명>` | 컴파일할 엔트리 포인트 |
| `-stage <스테이지>` | `compute`, `vertex`, `fragment` 등 |
| `-profile <프로필>` | `sm_5_1`, `sm_6_3`, `glsl_450` 등 |
| `-o <파일>` | 출력 파일 |
| `-I <경로>` | include/import 검색 경로 |
| `-D<이름>[=값]` | 전처리기 매크로 |
| `-g`, `-g1` | 디버그 정보 |
| `-O <레벨>` | 최적화 레벨 |

### 7.3 모듈 링크 예

```bash
# 한 번에 컴파일+링크
slangc entry.slang -target spirv -o program.spv

# 모듈 따로 컴파일 후 링크
slangc lib.slang -o lib.slang-module
slangc entry.slang -o entry.slang-module
slangc lib.slang-module entry.slang-module -target spirv -o program.spv
```

---

## 8. 간단한 예제

### 8.1 컴퓨트 셰이더

```slang
// hello-world.slang
StructuredBuffer<float> buffer0;
StructuredBuffer<float> buffer1;
RWStructuredBuffer<float> result;

[shader("compute")]
[numthreads(1, 1, 1)]
void computeMain(uint3 threadId : SV_DispatchThreadID)
{
    uint index = threadId.x;
    result[index] = buffer0[index] + buffer1[index];
}
```

### 8.2 버텍스 + 픽셀

```slang
// Vertex: 3 vertices, position float3, color float4 - simple triangle
// objectMat, viewMat, projMat are in separate descriptor set uniform buffers.
ConstantBuffer<float4x4> objectMat;  // descriptor set 0
ConstantBuffer<float4x4> viewMat;     // descriptor set 1
ConstantBuffer<float4x4> projMat;     // descriptor set 2

struct Vertex
{
    float3 position;
    float4 color;
}

struct VOut
{
    float4 position : SV_Position;
    float4 color;
}

[shader("vertex")]
VOut vertexMain(Vertex input)
{
    VOut output;
    float4 worldPos = mul(objectMat, float4(input.position, 1.0));
    float4 viewPos = mul(viewMat, worldPos);
    output.position = mul(projMat, viewPos);
    output.color = input.color;
    return output;
}

[shader("fragment")]
float4 fragmentMain(VOut input) : SV_Target
{
    return input.color;
}
```

---

## 9. 참고

- 공식 사용자 가이드: <https://shader-slang.org/slang/user-guide/>
- slangc 옵션 전체: <https://github.com/shader-slang/slang/blob/master/docs/command-line-slangc-reference.md>
- HLSL와 대부분 호환되며, 모듈/제네릭/인터페이스/자동 미분 등은 Slang 확장 기능이다.
